<!DOCTYPE html>
<html lang="ja">

  <head>
    <meta charset="UTF-8">
    <title>Reservation Form</title>
    <link href="https://cdn.jsdelivr.net/npm/@event-calendar/build@1.5.0/event-calendar.min.css" rel="stylesheet">
  </head>

  <body>
    <div class="container">
      <h2>Reservation Form</h2>
      {% if error_message %}
      <p style="color: red;">{{ error_message }}</p>
      {% endif %}
      <form method="post">
        {% csrf_token %}
        <div class="form-group">
          <label for="{{ form.name.id_for_label }}">名前:(本名だめ)</label>
          {{ form.name }}
        </div>
        <div class="form-group">
          <label for="{{ form.start_date.id_for_label }}">開始日:</label>
          {{ form.start_date }}
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>

    <div id="ec"></div>
    <script src="https://cdn.jsdelivr.net/npm/@event-calendar/build@1.5.0/event-calendar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
    <script>
      function createDate(hours, minutes) {
        const now = new Date();
        now.setHours(hours);
        now.setMinutes(minutes);
        now.setSeconds(0);
        return now;
      }

      const events = [{
        id: 1,
        start: createDate(9, 0),
        end: createDate(10, 30),
        title: 'Editable Event',
        editable: true,
      }, {
        id: 2,
        start: createDate(11, 0),
        end: createDate(13, 30),
        title: 'Uneditable Event',
        // editable: false, // not work
        startEditable: false,
        durationEditable: false,
        backgroundColor: 'red',
      }];

      // 初期イベント数
      const initialEventCount = events.length;

      function getOverlappingEvents(event) {
        // select event has event.resource.id
        // eventDrop event has event.resourceIds
        // ただし、対象とするイベントは初期イベント数のみ
        return ec.getEvents().filter(e => e.id != event.id && e.id <= initialEventCount && e.start < event.end && e.end > event.start);
      }

      function hasOverlappingEvents(event) {
        return getOverlappingEvents(event).length > 0;
      }

      function hasOtherOverlappingEvents(event) {
        return getOverlappingEvents(event).filter(e => e.id != event.id).length > 0
      }
      const ec = new EventCalendar(document.getElementById('ec'), {
        events,
        view: 'timeGridWeek',
        //        allDaySlot: false,
        //        slotMinTime: '08:00:00',
        //        slotMaxTime: '19:00:00',
        nowIndicator: true,
        selectable: true,
        //        select: function(event) {
        //          addEvent(event);
        //        }
        select: function(event) {
          if (hasOverlappingEvents(event)) {
            ec.unselect();
            return;
          }
          addEvent(event);
        },
        eventDrop: function ({ event, revert }) {
          if (hasOtherOverlappingEvents(event)) revert();
        },
        eventResize: function ({ event, revert }) {
          if (hasOtherOverlappingEvents(event)) revert();
        },
      });
      function addEvent(event) {
        event.id = new Date().getTime();
        ec.addEvent(event);
        ec.unselect();
        // 現在のイベント数が初期イベント数＋2を超えた場合、最新のイベントを削除
        const currentEventCount = ec.getEvents().length;
        if (currentEventCount > initialEventCount + 1) {
          currentEventId = ec.getEvents()[currentEventCount - 2].id;
          ec.removeEventById(currentEventId);
        }
      }
    </script>
  </body>
</html>
